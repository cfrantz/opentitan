# ML-DSA experiments for Earlgrey

## Introduction

This example is a rough port of the ML-DSA reference implementation to Earlgrey.

This port uses the KMAC accelerator to perform SHA3 and cSHAKE operations, but
the rest of the implementation executes on the Ibex RISCV core.  No attempt
at optimization has been done.

## Dilithium modes

ML-DSA (aka Dilithium) has three security levels: 2, 3 and 5.  The current code
can only be built to support one of these levels at a time.  The level is
controlled by the build flag `//sw/device/examples/mldsa/ref:mode`.  The default
setting is to use mode 5.

## Host program

There is a host-based demo program that uses OpenSSL to provide the underlying
hash primitives.  The demo program was used to create keys and sign messages
for use by the firmware tests.

```
bazel build \
    --//sw/device/examples/mldsa/ref:mode=5 \
    //sw/device/examples/mldsa/ref:demo
```

Generate keys, emitting secret and public keys `foo.sk` and `foo.pk`:
```
./bazel-bin/sw/device/examples/mldsa/ref/demo keygen foo
```

Sign a message, emitting the `.sig` file:
```
./bazel-bin/sw/device/examples/mldsa/ref/demo sign foo.sk message.txt message.sig
```

Verify a message:
```
./bazel-bin/sw/device/examples/mldsa/ref/demo verify foo.pk message.txt message.sig
```

## Pre-generated data for firmware

The directory `sw/device/examples/mldsa/data` contains 3 subdirectories
`mldsa44`, `mldsa65` and `mldsa87`.  Each of these subdirectories contains the
following:

| :File | Content |
|-------|---------|
| `foo.sk` | A secret key |
| `foo_sk.h` | A secret key as a C array |
| `foo.pk` | A public key |
| `foo_pk.h` | A public key as a C array |
| `message.txt` | A message to be signed |
| `message.h` | A message to be signed as a C array |
| `message.sig` | A signature over the message signed by `foo.sk` |
| `signature.h` | The signature as a C array |

Each of the above resources were generated by the host `demo` program built for
the various dilithium modes.

## Firmware demos

The firmware demos execute the ML-DSA reference implementaion on Earlgrey and
report timing and (optionally) stack utilization.  The demos may run on either
the CW310 FPGA or the Earlgrey ASIC.

Because the memory utilization of the ML-DSA reference utilization is so high,
the demos are "bare metal" binaries (ie: they do not use the OTTF.

### Keygen

To run the keygen demo on the ASIC using dilithium mode 2:
```
bazel test --test_output=streamed --nocache_test_results \
    --//signing:token=@provisioning_exts//shared/tokens:cloud_kms_gb \
    --copt=-DSTACK_UTILIZATION_CHECK=1 \
    --//sw/device/examples/mldsa/ref:mode=2 \
    //sw/device/examples/mldsa/fw:keygen_bm_silicon_owner_gb_rom_ext
```

### Sign

To run the signing demo on the ASIC using dilithium mode 2:
```
bazel test --test_output=streamed --nocache_test_results \
    --//signing:token=@provisioning_exts//shared/tokens:cloud_kms_gb \
    --copt=-DSTACK_UTILIZATION_CHECK=1 \
    --//sw/device/examples/mldsa/ref:mode=2 \
    //sw/device/examples/mldsa/fw:sign_bm_silicon_owner_gb_rom_ext
```

### Verify

To run the verify demo on the ASIC using dilithium mode 2:
```
bazel test --test_output=streamed --nocache_test_results \
    --//signing:token=@provisioning_exts//shared/tokens:cloud_kms_gb \
    --copt=-DSTACK_UTILIZATION_CHECK=1 \
    --//sw/device/examples/mldsa/ref:mode=2 \
    //sw/device/examples/mldsa/fw:verify_bm_silicon_owner_gb_rom_ext
```

## Results

| Operation | Mode | Time | Stack Usage |
|-|-|-|-|
| Keygen | 2 | 8.31ms  | 38232 bytes |
|        | 3 | 13.3ms  | 60776 bytes |
|        | 5 | 21.31ms | 97640 bytes |
| Sign   | 2 | 40.9ms  | 51976 bytes |
|        | 3 | 91.5ms  | 79624 bytes |
|        | 5 | 128.5ms | 122648 bytes |
| Verify | 2 | 10.5ms  | 36184 bytes |
|        | 3 | 16.2ms  | 57720 bytes |
|        | 5 | 24.7ms  | 92840 bytes |

> NOTE: the stack usage numbers include a small amount of test program overhead.  The overhead is negligible.
