# SLH-DSA experiments for Earlgrey

## Introduction

This example is a rough port of the SLH-DSA reference implementation to Earlgrey.

This port uses the HMAC accelerator to perform SHA2 operations, but
the rest of the implementation executes on the Ibex RISCV core.  No attempt
at optimization has been done.

## Sphincs+ modes

SLH-DSA (aka Sphincs+) has a multitude of variations based on the hash
function, hash block size and other parameters.

We only really care about the SHA2-128s-simple variant.  This is the same
variant built into the ROM, ROM\_EXT and our rust-based tooling.

I changed the `deterministic` variant to use an LCG random number generator for
simplicity and to verify that keygen produces identical results on both the host
and firmware implementations.  The `random` variant uses `/dev/random` on the
host and the Ibex RNG on the device.

## Host program

There is a host-based demo program that uses the reference library to
provide the underlying hash primitives.  The demo program was used to
create keys and sign messages for use by the firmware tests.

```
bazel build \
    //sw/device/examples/slhdsa/ref:demo
```

Generate keys, emitting secret and public keys `foo.sk` and `foo.pk`:
```
./bazel-bin/sw/device/examples/slhdsa/ref/demo keygen foo
```

Sign a message, emitting the `.sig` file:
```
./bazel-bin/sw/device/examples/slhdsa/ref/demo sign foo.sk message.txt message.sig
```

Verify a message:
```
./bazel-bin/sw/device/examples/slhdsa/ref/demo verify foo.pk message.txt message.sig
```

## Pre-generated data for firmware

The directory `sw/device/examples/slhdsa/data` contains a `sha2_128s_simple`
subdirectory with the following:

| :File | Content |
|-------|---------|
| `foo.sk` | A secret key |
| `foo_sk.h` | A secret key as a C array |
| `foo.pk` | A public key |
| `foo_pk.h` | A public key as a C array |
| `message.txt` | A message to be signed |
| `message.h` | A message to be signed as a C array |
| `message.sig` | A signature over the message signed by `foo.sk` |
| `signature.h` | The signature as a C array |

Each of the above resources were generated by the host `demo` program.

## Firmware demos

The firmware demos execute the SLH-DSA reference implementaion on Earlgrey and
report timing and (optionally) stack utilization.  The demos may run on either
the CW310 FPGA or the Earlgrey ASIC.

### Keygen

To run the keygen demo on the ASIC:
```
bazel test --test_output=streamed --nocache_test_results \
    --//signing:token=@provisioning_exts//shared/tokens:cloud_kms_gb \
    --copt=-DSTACK_UTILIZATION_CHECK=1 \
    //sw/device/examples/slhdsa/fw:keygen_bm_silicon_owner_gb_rom_ext
```

### Sign

To run the signing demo on the ASIC:
```
bazel test --test_output=streamed --nocache_test_results \
    --//signing:token=@provisioning_exts//shared/tokens:cloud_kms_gb \
    --copt=-DSTACK_UTILIZATION_CHECK=1 \
    //sw/device/examples/slhdsa/fw:sign_bm_silicon_owner_gb_rom_ext
```

### Verify

To run the verify demo on the ASIC:
```
bazel test --test_output=streamed --nocache_test_results \
    --//signing:token=@provisioning_exts//shared/tokens:cloud_kms_gb \
    --copt=-DSTACK_UTILIZATION_CHECK=1 \
    //sw/device/examples/slhdsa/fw:verify_bm_silicon_owner_gb_rom_ext
```

## Results

| Operation | Mode | Time | Stack Usage |
|-|-|-|-|
| Keygen | SHA2-128s-simple | 1257 ms  | 2152 bytes |
| Sign   | SHA2-128s-simple | 9739 ms  | 1480 bytes |
| Verify | SHA2-128s-simple | 12 ms  | 1956 bytes |

> NOTE: the stack usage numbers include a small amount of test program overhead.  The overhead is negligible.

### Pure software solution

As an experiment, a pure software implementation was tested on the
Earlgrey ASIC.  Computing Sphincs+ results efficiently requires the
ability to save and restore a SHA2 context.  An implementation without
a capable SHA2 accelerator is exteremly slow.

| Operation | Mode | Time | Stack Usage |
|-|-|-|-|
| Keygen | SHA2-128s-simple | 31907 ms  | 3508 bytes |
| Sign   | SHA2-128s-simple | 241217 ms  | 2836 bytes |
| Verify | SHA2-128s-simple | 254 ms  | 2308 bytes |
